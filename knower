#!/usr/bin/env bash
set -e

# ── Config ──────────────────────────────────────────────────────────────────
CONFIG="$HOME/.config/knower/config"
RUNTIME_DIR="$HOME/.local/share/knower"
PID_FILE="$RUNTIME_DIR/knower-core.pid"
LOG_DIR="$RUNTIME_DIR/logs"
LOG_FILE="$LOG_DIR/core.log"

[[ -f "$CONFIG" ]] && source "$CONFIG"
[[ -n "$KNOWER_HOME" ]] || { echo "❌ KNOWER_HOME not set. Run ./install.sh first."; exit 1; }

CORE_PORT="${CORE_PORT:-8000}"
VENV="$KNOWER_HOME/core/.venv/bin/activate"
START_SCRIPT="$KNOWER_HOME/core/start.sh"

mkdir -p "$LOG_DIR"

# ── Helpers ──────────────────────────────────────────────────────────────────
is_running() {
  [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null
}

_export_env() {
  export KNOWER_HOME CORE_PORT VAULT_PATH KNOWER_ENV
}

_require_vault() {
  [[ -n "$VAULT_PATH" ]] || { echo "❌ VAULT_PATH not set. Run: knower config vault <path>"; exit 1; }
}

_start_core_bg() {
  # Usage: _start_core_bg <log_file>
  source "$VENV"
  nohup bash "$START_SCRIPT" >> "$1" 2>&1 &
  echo $! > "$PID_FILE"
  echo "✅ Core started (PID $!)"
}

# ── Commands ─────────────────────────────────────────────────────────────────

cmd_dev() {
  VAULT_PATH="$KNOWER_HOME/vault"
  KNOWER_ENV=dev
  _export_env

  if is_running; then
    echo "⚠️  Core already running (PID $(cat "$PID_FILE")). Stop it first: knower stop"
    exit 1
  fi

  echo "➜  Starting core (dev, hot-reload)..."
  source "$VENV"
  bash "$START_SCRIPT" &        # no nohup, no redirect — stdout/stderr go to terminal
  echo $! > "$PID_FILE"
  echo "✅ Core started (PID $!)"

  echo "➜  Starting web (:5173)..."
  cd "$KNOWER_HOME/web"
  [[ -d node_modules ]] || npm install --silent
  npm run dev
}

cmd_start() {
  # Prod mode: core in background, reads VAULT_PATH from config.
  _require_vault

  if is_running; then
    echo "⚠️  Already running (PID $(cat "$PID_FILE")). Use 'knower stop' first."
    exit 0
  fi

  KNOWER_ENV=prod
  _export_env

  echo "➜  Starting core (prod) — vault: $VAULT_PATH"
  _start_core_bg "$LOG_FILE"
  echo "   Logs: knower logs"
}

cmd_stop() {
  if is_running; then
    kill "$(cat "$PID_FILE")"
    rm -f "$PID_FILE"
    echo "✅ Core stopped."
  else
    echo "⚠️  Core is not running."
    rm -f "$PID_FILE"
  fi
}

cmd_status() {
  echo ""
  echo "  KNOWER_HOME : $KNOWER_HOME"
  echo "  VAULT_PATH  : ${VAULT_PATH:-not set}"
  echo "  CORE_PORT   : $CORE_PORT"
  if is_running; then
    echo "  Core        : ✅ running (PID $(cat "$PID_FILE"))"
  else
    echo "  Core        : ⛔ stopped"
  fi
  echo ""
}

cmd_logs() {
  [[ -f "$LOG_FILE" ]] || { echo "No log file yet. Run 'knower start' first."; exit 1; }
  tail -f "$LOG_FILE"
}

cmd_web() {
  # Start the Vite dev server. Foreground by default, --bg for background.
  local bg=false
  [[ "${2:-}" == "--bg" ]] && bg=true

  cd "$KNOWER_HOME/web"
  [[ -d node_modules ]] || npm install --silent

  if [[ "$bg" == true ]]; then
    nohup npm run dev >> "$LOG_DIR/web.log" 2>&1 &
    echo "✅ Web started in background (PID $!). Port: 5173"
    echo "   Logs: tail -f $LOG_DIR/web.log"
  else
    npm run dev
  fi
}

cmd_vault() {
  _require_vault
  open "$VAULT_PATH"
}

cmd_config() {
  case "${2:-}" in
    vault)
      [[ -n "${3:-}" ]] || { echo "Usage: knower config vault <path>"; exit 1; }
      VAULT_ABS="$(cd "$(dirname "$3")" 2>/dev/null && pwd)/$(basename "$3")" || VAULT_ABS="$3"
      mkdir -p "$VAULT_ABS"
      if grep -q "^VAULT_PATH=" "$CONFIG" 2>/dev/null; then
        sed -i '' "s|^VAULT_PATH=.*|VAULT_PATH=$VAULT_ABS|" "$CONFIG"
      else
        echo "VAULT_PATH=$VAULT_ABS" >> "$CONFIG"
      fi
      echo "✅ Vault set → $VAULT_ABS"
      ;;
    show)
      echo ""
      cat "$CONFIG"
      echo ""
      ;;
    *)
      echo "Usage:"
      echo "  knower config vault <path>   Set vault path"
      echo "  knower config show           Print current config"
      exit 1
      ;;
  esac
}

cmd_shell() {
  echo "➜  Entering Knower Python environment..."
  echo "   (type 'exit' to leave)"
  
  # Manually set the virtual environment variables
  export VIRTUAL_ENV="$KNOWER_HOME/core/.venv"
  export PATH="$VIRTUAL_ENV/bin:$PATH"
  unset PYTHONHOME
  
  # Replace current process with a new interactive shell
  exec "${SHELL:-/bin/bash}"
}

# ── Router ───────────────────────────────────────────────────────────────────
case "${1:-}" in
  dev)      cmd_dev ;;
  start)    cmd_start ;;
  stop)     cmd_stop ;;
  status)   cmd_status ;;
  logs)     cmd_logs ;;
  web)      cmd_web "$@" ;;
  vault)    cmd_vault ;;
  config)   cmd_config "$@" ;;
  shell)     cmd_shell ;;

  help|"")
    echo ""
    echo "Usage: knower <command>"
    echo ""
    echo "  dev                    Dev mode: core (bg, hot-reload) + web (fg)"
    echo "  start                  Prod: start core in background"
    echo "  stop                   Stop core"
    echo "  status                 Show config and running state"
    echo "  logs                   Tail core log (prod)"
    echo "  web [--bg]             Start Vite dev server"
    echo "  vault                  Open vault in Finder"
    echo "  config vault <path>    Set vault path"
    echo "  config show            Print current config"
    echo "  shell                  Open shell with Python venv activated"
    echo ""
    ;;
  *)
    echo "❌ Unknown command: '$1'. Run 'knower help'."
    exit 1
    ;;
esac
