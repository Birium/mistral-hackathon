#!/usr/bin/env bash
set -e

# ── Config ──────────────────────────────────────────────────────────────────
CONFIG="$HOME/.config/knower/config"
RUNTIME_DIR="$HOME/.local/share/knower"
PID_FILE="$RUNTIME_DIR/knower-core.pid"
LOG_DIR="$RUNTIME_DIR/logs"
LOG_FILE="$LOG_DIR/core.log"

[[ -f "$CONFIG" ]] && source "$CONFIG"
[[ -n "$KNOWER_HOME" ]] || { echo "❌ KNOWER_HOME not set. Run ./install.sh first."; exit 1; }

CORE_PORT="${CORE_PORT:-8000}"
VENV="$KNOWER_HOME/core/.venv/bin/activate"
START_SCRIPT="$KNOWER_HOME/core/start.sh"

mkdir -p "$LOG_DIR"

# ── Helpers ──────────────────────────────────────────────────────────────────
is_running() {
  [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null
}

_export_env() {
  export KNOWER_HOME CORE_PORT VAULT_PATH KNOWER_ENV
}

_require_vault() {
  [[ -n "$VAULT_PATH" ]] || { echo "❌ VAULT_PATH not set. Run: knower config vault <path>"; exit 1; }
}

_start_core_bg() {
  source "$VENV"
  nohup bash "$START_SCRIPT" >> "$1" 2>&1 &
  echo $! > "$PID_FILE"
  echo "✅ Core started (PID $!)"
}

# ── Commands ─────────────────────────────────────────────────────────────────

cmd_dev() {
  VAULT_PATH="$KNOWER_HOME/vault"
  KNOWER_ENV=dev
  _export_env

  if is_running; then
    echo "⚠️  Core already running (PID $(cat "$PID_FILE")). Stop it first: knower stop"
    exit 1
  fi

  echo "➜  Starting core (dev, hot-reload)..."
  source "$VENV"
  bash "$START_SCRIPT" &
  CORE_PID=$!
  echo $CORE_PID > "$PID_FILE"
  echo "✅ Core started (PID $CORE_PID)"

  trap 'kill $CORE_PID 2>/dev/null; rm -f "$PID_FILE"; echo ""; echo "✅ Core stopped."' EXIT INT TERM

  echo "➜  Starting web (:5173)..."
  cd "$KNOWER_HOME/web"
  [[ -d node_modules ]] || npm install --silent
  npm run dev
}

cmd_start() {
  _require_vault

  if is_running; then
    echo "⚠️  Already running (PID $(cat "$PID_FILE")). Use 'knower stop' first."
    exit 0
  fi

  KNOWER_ENV=prod
  _export_env

  echo "➜  Starting core (prod) — vault: $VAULT_PATH"
  _start_core_bg "$LOG_FILE"
  echo "   Logs: knower logs"
}

cmd_stop() {
  if is_running; then
    kill "$(cat "$PID_FILE")"
    rm -f "$PID_FILE"
    echo "✅ Core stopped."
  else
    echo "⚠️  Core is not running."
    rm -f "$PID_FILE"
  fi
}

cmd_status() {
  echo ""
  echo "  KNOWER_HOME : $KNOWER_HOME"
  echo "  VAULT_PATH  : ${VAULT_PATH:-not set}"
  echo "  CORE_PORT   : $CORE_PORT"
  if is_running; then
    echo "  Core        : ✅ running (PID $(cat "$PID_FILE"))"
  else
    echo "  Core        : ⛔ stopped"
  fi
  echo ""
}

cmd_logs() {
  [[ -f "$LOG_FILE" ]] || { echo "No log file yet. Run 'knower start' first."; exit 1; }
  tail -f "$LOG_FILE"
}

cmd_web() {
  local bg=false
  [[ "${2:-}" == "--bg" ]] && bg=true

  cd "$KNOWER_HOME/web"
  [[ -d node_modules ]] || npm install --silent

  if [[ "$bg" == true ]]; then
    nohup npm run dev >> "$LOG_DIR/web.log" 2>&1 &
    echo "✅ Web started in background (PID $!). Port: 5173"
    echo "   Logs: tail -f $LOG_DIR/web.log"
  else
    npm run dev
  fi
}

cmd_vault() {
  _require_vault
  open "$VAULT_PATH"
}

cmd_config() {
  case "${2:-}" in
    vault)
      [[ -n "${3:-}" ]] || { echo "Usage: knower config vault <path>"; exit 1; }
      VAULT_ABS="$(cd "$(dirname "$3")" 2>/dev/null && pwd)/$(basename "$3")" || VAULT_ABS="$3"
      mkdir -p "$VAULT_ABS"
      if grep -q "^VAULT_PATH=" "$CONFIG" 2>/dev/null; then
        sed -i '' "s|^VAULT_PATH=.*|VAULT_PATH=$VAULT_ABS|" "$CONFIG"
      else
        echo "VAULT_PATH=$VAULT_ABS" >> "$CONFIG"
      fi
      echo "✅ Vault set → $VAULT_ABS"
      ;;
    show)
      echo ""
      sed -E 's/^([A-Za-z_]*_KEY=).*/\1****/' "$CONFIG"
      echo ""
      ;;
    *)
      echo "Usage:"
      echo "  knower config vault <path>   Set vault path"
      echo "  knower config show           Print current config"
      exit 1
      ;;
  esac
}

cmd_shell() {
  echo "➜  Entering Knower Python environment..."
  echo "   (type 'exit' to leave)"
  export VIRTUAL_ENV="$KNOWER_HOME/core/.venv"
  export PATH="$VIRTUAL_ENV/bin:$PATH"
  unset PYTHONHOME
  exec "${SHELL:-/bin/bash}"
}

cmd_uninstall() {
  # ── Flag parsing ────────────────────────────────────────────────────────
  local purge=false
  local with_vault=false

  for arg in "${@:2}"; do
    case "$arg" in
      --purge)      purge=true ;;
      --with-vault) with_vault=true ;;
    esac
  done

  # ── Summary ─────────────────────────────────────────────────────────────
  echo ""
  echo "  This will remove:"
  echo "    • /usr/local/bin/knower (symlink)"
  echo "    • $HOME/.config/knower/"
  echo "    • $RUNTIME_DIR/"
  echo "    • $KNOWER_HOME/core/.venv/"
  if [[ "$purge" == true ]]; then
    echo "    • ~/.cache/qmd/  (models, ~2 GB)"
    echo "    • @tobilu/qmd    (npm global package)"
  fi
  if [[ "$with_vault" == true ]]; then
    echo "    • $VAULT_PATH  ⚠️  YOUR VAULT — ALL NOTES WILL BE DELETED"
  fi
  echo ""

  # ── Vault double-confirmation ────────────────────────────────────────────
  if [[ "$with_vault" == true ]]; then
    [[ -n "$VAULT_PATH" ]] || { echo "❌ VAULT_PATH is not set — nothing to delete."; exit 1; }
    echo "  ⚠️  You asked to delete your vault at:"
    echo "     $VAULT_PATH"
    echo ""
    echo "  Type the full vault path to confirm:"
    read -r vault_confirm
    if [[ "$vault_confirm" != "$VAULT_PATH" ]]; then
      echo "❌ Path did not match. Aborting."
      exit 1
    fi
  fi

  # ── Final confirmation ───────────────────────────────────────────────────
  read -r -p "  Proceed? [y/N] " confirm
  [[ "$confirm" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 0; }
  echo ""

  # ── Stop core if running ─────────────────────────────────────────────────
  if is_running; then
    echo "➜  Stopping core (PID $(cat "$PID_FILE"))..."
    kill "$(cat "$PID_FILE")" 2>/dev/null || true
    rm -f "$PID_FILE"
    echo "  ✅ Core stopped."
  fi

  # ── Remove symlink ───────────────────────────────────────────────────────
  if [[ -L /usr/local/bin/knower ]]; then
    echo "➜  Removing symlink..."
    sudo rm -f /usr/local/bin/knower
    echo "  ✅ /usr/local/bin/knower removed."
  fi

  # ── Remove config ────────────────────────────────────────────────────────
  if [[ -d "$HOME/.config/knower" ]]; then
    echo "➜  Removing config..."
    rm -rf "$HOME/.config/knower"
    echo "  ✅ ~/.config/knower/ removed."
  fi

  # ── Remove runtime dir (logs, PID) ──────────────────────────────────────
  if [[ -d "$RUNTIME_DIR" ]]; then
    echo "➜  Removing runtime dir..."
    rm -rf "$RUNTIME_DIR"
    echo "  ✅ $RUNTIME_DIR removed."
  fi

  # ── Remove Python venv ───────────────────────────────────────────────────
  if [[ -d "$KNOWER_HOME/core/.venv" ]]; then
    echo "➜  Removing Python venv..."
    rm -rf "$KNOWER_HOME/core/.venv"
    echo "  ✅ core/.venv removed."
  fi

  # ── Purge: QMD models + npm package ─────────────────────────────────────
  if [[ "$purge" == true ]]; then
    if [[ -d "$HOME/.cache/qmd" ]]; then
      echo "➜  Removing QMD cache (~2 GB)..."
      rm -rf "$HOME/.cache/qmd"
      echo "  ✅ ~/.cache/qmd/ removed."
    fi

    if command -v qmd &>/dev/null; then
      echo "➜  Uninstalling @tobilu/qmd..."
      npm uninstall -g @tobilu/qmd --silent
      echo "  ✅ @tobilu/qmd uninstalled."
    fi
  fi

  # ── Vault ────────────────────────────────────────────────────────────────
  if [[ "$with_vault" == true && -d "$VAULT_PATH" ]]; then
    echo "➜  Deleting vault..."
    rm -rf "$VAULT_PATH"
    echo "  ✅ $VAULT_PATH removed."
  fi

  # ── Done ─────────────────────────────────────────────────────────────────
  echo ""
  echo "✅ Knower uninstalled."
  if [[ "$purge" == false ]]; then
    echo "   QMD models and npm package were kept. Re-run with --purge to remove them."
  fi
  if [[ "$with_vault" == false && -n "$VAULT_PATH" ]]; then
    echo "   Vault kept at $VAULT_PATH. Re-run with --with-vault to delete it."
  fi
  echo ""
}

# ── Router ───────────────────────────────────────────────────────────────────
case "${1:-}" in
  dev)        cmd_dev ;;
  start)      cmd_start ;;
  stop)       cmd_stop ;;
  status)     cmd_status ;;
  logs)       cmd_logs ;;
  web)        cmd_web "$@" ;;
  vault)      cmd_vault ;;
  config)     cmd_config "$@" ;;
  shell)      cmd_shell ;;
  uninstall)  cmd_uninstall "$@" ;;

  help|"")
    echo ""
    echo "Usage: knower <command>"
    echo ""
    echo "  dev                    Dev mode: core (bg, hot-reload) + web (fg)"
    echo "  start                  Prod: start core in background"
    echo "  stop                   Stop core"
    echo "  status                 Show config and running state"
    echo "  logs                   Tail core log (prod)"
    echo "  web [--bg]             Start Vite dev server"
    echo "  vault                  Open vault in Finder"
    echo "  config vault <path>    Set vault path"
    echo "  config show            Print current config"
    echo "  shell                  Open shell with Python venv activated"
    echo "  uninstall              Remove Knower (keeps vault and QMD models)"
    echo "    --purge              Also remove QMD models (~2 GB) and npm package"
    echo "    --with-vault         Also delete the vault (requires path confirmation)"
    echo ""
    ;;
  *)
    echo "❌ Unknown command: '$1'. Run 'knower help'."
    exit 1
    ;;
esac
